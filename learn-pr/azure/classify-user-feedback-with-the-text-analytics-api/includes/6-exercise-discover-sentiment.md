<span data-ttu-id="d0440-101">Nu uppdaterar vi vår funktionsimplementering för att anropa API för textanalys-tjänsten och få en sentimentpoäng.</span><span class="sxs-lookup"><span data-stu-id="d0440-101">Let's update our function implementation to call the Text Analytics API service and get back a sentiment score.</span></span>

1. <span data-ttu-id="d0440-102">Välj vår funktion, [!INCLUDE [func-name-discover](./func-name-discover.md)], i funktionsappen på portalen.</span><span class="sxs-lookup"><span data-stu-id="d0440-102">Select our function, [!INCLUDE [func-name-discover](./func-name-discover.md)], in our function app in the portal.</span></span>

1. <span data-ttu-id="d0440-103">Utöka menyn **Visa filer** till höger på skärmen.</span><span class="sxs-lookup"><span data-stu-id="d0440-103">Expand the **View files** menu on the right of the screen.</span></span>

1. <span data-ttu-id="d0440-104">Under fliken **Visa filer** väljer du **index.js** för att öppna kodfilen i redigeringsprogrammet.</span><span class="sxs-lookup"><span data-stu-id="d0440-104">Under the **View files** tab, select **index.js** to open the code file in the editor.</span></span>

1. <span data-ttu-id="d0440-105">Ersätt hela innehållet i **index.js** med följande JavaScript och **Spara**.</span><span class="sxs-lookup"><span data-stu-id="d0440-105">Replace the entire content of **index.js** with the following JavaScript and **Save**.</span></span>

    [!code-javascript[](../code/discover-sentiment-sort.js?highlight=7)]

1. <span data-ttu-id="d0440-106">Uppdatera värdet för `accessKey` i koden som du klistrade in med åtkomstnyckeln för API för textanalys, som du sparade tidigare i den här modulen.</span><span class="sxs-lookup"><span data-stu-id="d0440-106">Update the value of `accessKey` in the code you pasted with the access key for the Text Analytics API that you saved earlier in this module.</span></span> 

1. <span data-ttu-id="d0440-107">Uppdatera värdet för `uri` med den region som du fick din åtkomstnyckel från.</span><span class="sxs-lookup"><span data-stu-id="d0440-107">Update the `uri` value with the region from which you obtained your access key.</span></span>

<span data-ttu-id="d0440-108">Vi tittar på vad som händer i den här koden:</span><span class="sxs-lookup"><span data-stu-id="d0440-108">Let's look at what's happening in this code:</span></span>

- <span data-ttu-id="d0440-109">Varje anrop till Text Analytics-tjänsten behöver åtkomst till nyckeln, som vi lägger till som `Ocp-Apim-Subscription-Key`-huvud.</span><span class="sxs-lookup"><span data-stu-id="d0440-109">Each call to the Text Analytics service, needs the access key, which we add as the `Ocp-Apim-Subscription-Key` header.</span></span> 
- <span data-ttu-id="d0440-110">Varje anrop görs till en regionsspecifik slutpunkt, definierad av `uri` i vår kod.</span><span class="sxs-lookup"><span data-stu-id="d0440-110">Each call is made to a region-specific endpoint, defined by `uri` in our code.</span></span>
- <span data-ttu-id="d0440-111">Längst ned i kodfilen har vi definierat en `documents`-matris.</span><span class="sxs-lookup"><span data-stu-id="d0440-111">At the bottom of the code file, we've defined a `documents` array.</span></span> <span data-ttu-id="d0440-112">Den här matrisen är den nyttolast som vi skickar till textanalystjänsten.</span><span class="sxs-lookup"><span data-stu-id="d0440-112">This array is the payload we send to the Text Analytics service.</span></span>
- <span data-ttu-id="d0440-113">`documents`-matrisen innehåller en enda post i det här fallet, vilket är det kömeddelande som utlöste vår funktion.</span><span class="sxs-lookup"><span data-stu-id="d0440-113">The `documents` array has a single entry in this case, which is the queue message that triggered our function.</span></span> <span data-ttu-id="d0440-114">Även om vi har bara ett dokument i matrisen betyder det inte att vår lösning bara kan hantera ett meddelande i taget.</span><span class="sxs-lookup"><span data-stu-id="d0440-114">Although we only have one document in our array, it doesn't mean that our solution can only handle one message at a time.</span></span> <span data-ttu-id="d0440-115">Azure Functions-körmiljön hämtar och bearbetar meddelanden i batchar och anropar flera instanser av funktionen *parallellt*.</span><span class="sxs-lookup"><span data-stu-id="d0440-115">The Azure Functions runtime retrieves and processes messages in batches, calling several instances of our function *in parallel*.</span></span> <span data-ttu-id="d0440-116">För närvarande är standardstorleken för batchar 16, och den maximala batchstorleken är 32.</span><span class="sxs-lookup"><span data-stu-id="d0440-116">Currently, the default batch size is 16 and the maximum batch size is 32.</span></span>
- <span data-ttu-id="d0440-117">`id` måste vara unikt i matrisen.</span><span class="sxs-lookup"><span data-stu-id="d0440-117">The `id` must be unique within the array.</span></span> <span data-ttu-id="d0440-118">Egenskapen `language` anger språket i dokumenttexten.</span><span class="sxs-lookup"><span data-stu-id="d0440-118">The `language` property specifies the language of the document text.</span></span>
- <span data-ttu-id="d0440-119">Vi anropar sedan metoden `get_sentiments`, som använder HTTPS-modulen för att göra anrop till API för textanalys.</span><span class="sxs-lookup"><span data-stu-id="d0440-119">We then call our method `get_sentiments`, which uses the HTTPS module to make the call to Text Analytics API.</span></span> <span data-ttu-id="d0440-120">Observera att vi skickar vår prenumerationsnyckel, eller åtkomstnyckel, i huvudet för varje begäran.</span><span class="sxs-lookup"><span data-stu-id="d0440-120">Notice that we pass our subscription, or access, key in the header of every request.</span></span>
- <span data-ttu-id="d0440-121">När tjänsten returnerar anropas vår `response_handler`, och vi loggar svaret till konsolen med hjälp av `context.log`</span><span class="sxs-lookup"><span data-stu-id="d0440-121">When the service returns, our `response_handler` is called, and we log the response to the console using `context.log`</span></span>


## <a name="try-it-out"></a><span data-ttu-id="d0440-122">Prova</span><span class="sxs-lookup"><span data-stu-id="d0440-122">Try it out</span></span>

<span data-ttu-id="d0440-123">Innan vi tittar på att sortera i köer gör vi en testkörning av det vi har hittills.</span><span class="sxs-lookup"><span data-stu-id="d0440-123">Before we look at sorting into queues, let's take what we have for a test run.</span></span>

1. <span data-ttu-id="d0440-124">Med vår funktion, [!INCLUDE [func-name-discover](./func-name-discover.md)], vald i portalen Funktionsappar, klickar du på menyalternativet **Testa** längst till höger.</span><span class="sxs-lookup"><span data-stu-id="d0440-124">With our function, [!INCLUDE [func-name-discover](./func-name-discover.md)], selected in the Function Apps area of the portal, click on the **Test** menu item on the far right.</span></span>

1. <span data-ttu-id="d0440-125">Välj menyalternativet **Testa** och se till att testpanelen är öppen.</span><span class="sxs-lookup"><span data-stu-id="d0440-125">Select the **Test** menu item, and verify that you have the test panel open.</span></span>

1. <span data-ttu-id="d0440-126">Lägg till en textsträng i begärandetexten enligt det som visas på skärmbilden.</span><span class="sxs-lookup"><span data-stu-id="d0440-126">Add a string of text into the request body as shown in the screenshot.</span></span>

    ![Skärmbild som visar funktionen Testpanel expanderad.](../media/test-panel-open-small.png)

1.  <span data-ttu-id="d0440-128">Klicka på **Kör** längst ned på testpanelen.</span><span class="sxs-lookup"><span data-stu-id="d0440-128">Click **Run** at the bottom of the test panel.</span></span>

1. <span data-ttu-id="d0440-129">Kontrollera att fliken **Loggar** expanderas längst ned till vänster på huvudskärmen under kodredigeraren.</span><span class="sxs-lookup"><span data-stu-id="d0440-129">Make sure the **Logs** tab is expanded at the bottom left of the main screen, under the code editor.</span></span>

1. <span data-ttu-id="d0440-130">Kontrollera att fliken **Loggar** visar logginformation som funktionen har slutfört.</span><span class="sxs-lookup"><span data-stu-id="d0440-130">Verify that the **Logs** tab displays log information that the function completed.</span></span> <span data-ttu-id="d0440-131">I fönstret visas även svaret från API för textanalys-anropet.</span><span class="sxs-lookup"><span data-stu-id="d0440-131">The window will also display the response from the Text Analytics API call.</span></span>

    ![Skärmbild som visar testpanelen och resultatet av ett lyckat test.](../media/sentiment-response-log1.png)

<span data-ttu-id="d0440-133">Grattis!</span><span class="sxs-lookup"><span data-stu-id="d0440-133">Congratulations!</span></span> <span data-ttu-id="d0440-134">[!INCLUDE [func-name-discover](./func-name-discover.md)] fungerar som avsett.</span><span class="sxs-lookup"><span data-stu-id="d0440-134">The [!INCLUDE [func-name-discover](./func-name-discover.md)] works as designed.</span></span> <span data-ttu-id="d0440-135">I det här exemplet skickade vi ett väldigt positivt meddelande och fick ett resultat på över 0,98.</span><span class="sxs-lookup"><span data-stu-id="d0440-135">In this example, we passed in a very upbeat message and received a score of over 0.98.</span></span> <span data-ttu-id="d0440-136">Försök att ändra meddelandet till något mindre optimistiskt. Kör sedan testet och notera svaret.</span><span class="sxs-lookup"><span data-stu-id="d0440-136">Try changing the message to something less optimistic, rerun the test, and note the response.</span></span>

## <a name="add-a-message-to-the-queue"></a><span data-ttu-id="d0440-137">Lägga till ett meddelande i kön</span><span class="sxs-lookup"><span data-stu-id="d0440-137">Add a message to the queue</span></span>

<span data-ttu-id="d0440-138">Vi upprepar testet.</span><span class="sxs-lookup"><span data-stu-id="d0440-138">Let's repeat the test.</span></span> <span data-ttu-id="d0440-139">I stället för att använda testfönstret i portalen placerar vi den här gången ett meddelande i indatakön och ser vad som händer.</span><span class="sxs-lookup"><span data-stu-id="d0440-139">This time, instead of using the Test window of the portal, we'll actually place a message into the input queue and watch what happens.</span></span>

1. <span data-ttu-id="d0440-140">Gå till din resursgrupp i delen **Resursgrupper** i portalen.</span><span class="sxs-lookup"><span data-stu-id="d0440-140">Navigate to your resource group in the **Resource Groups** section of the portal.</span></span>

1. <span data-ttu-id="d0440-141">Välj <rgn>[Resursgruppsnamn för sandbox-miljö]</rgn>, resursgruppen som används i den här enheten.</span><span class="sxs-lookup"><span data-stu-id="d0440-141">Select <rgn>[sandbox resource group name]</rgn>, the resource group used in this lesson.</span></span>

1. <span data-ttu-id="d0440-142">I panelen **Resursgrupp** som visas letar du reda på lagringskontot och markerar det.</span><span class="sxs-lookup"><span data-stu-id="d0440-142">In the **Resource group** panel that appears, locate the Storage Account entry, and select it.</span></span>

    ![Skärmbild av valt lagringskonto i fönstret Resursgrupp.](../media/select-storage-account.png)

1. <span data-ttu-id="d0440-144">Välj **Storage Explorer (förhandsversion)** på den västra menyn i lagringskontots huvudfönster.</span><span class="sxs-lookup"><span data-stu-id="d0440-144">Select **Storage Explorer (preview)** from the left menu of the Storage Account main window.</span></span> <span data-ttu-id="d0440-145">Den här åtgärden öppnar Azure Storage Explorer i portalen.</span><span class="sxs-lookup"><span data-stu-id="d0440-145">This action opens the Azure Storage Explorer inside the portal.</span></span> 

    ![Skärmbild av Storage Explorer som visar vårt lagringskonto, utan köer för närvarande.](../media/sa-no-queue.png)

    <span data-ttu-id="d0440-147">Som du ser har vi inte några köer i det här lagringskontot än, så vi lägger till en.</span><span class="sxs-lookup"><span data-stu-id="d0440-147">As you can see, we don't have any queues in this storage account yet, so let's add one.</span></span>

5. <span data-ttu-id="d0440-148">Som du kanske kommer ihåg från en tidigare del i den här enheten gav vi kön ett namn som är associerat med vår utlösare **new-feedback-q**.</span><span class="sxs-lookup"><span data-stu-id="d0440-148">If you remember from earlier in this lesson, we named the queue associated with our trigger **new-feedback-q**.</span></span> <span data-ttu-id="d0440-149">Högerklicka på objektet **Queues** (Köer) i lagringsutforskaren och välj *Skapa kö*.</span><span class="sxs-lookup"><span data-stu-id="d0440-149">Right-click on the **Queues** item in the Storage Explorer, and select *Create Queue*.</span></span>

1. <span data-ttu-id="d0440-150">I den dialogruta som öppnas anger du **new-feedback-q** och klickar på **OK**.</span><span class="sxs-lookup"><span data-stu-id="d0440-150">In the dialog that opens, enter **new-feedback-q** and click **OK**.</span></span> <span data-ttu-id="d0440-151">Nu har vi vår indatakö.</span><span class="sxs-lookup"><span data-stu-id="d0440-151">We now have our input queue.</span></span>

1. <span data-ttu-id="d0440-152">Välj den nya kön på menyn till vänster så ser du datautforskaren för den här kön.</span><span class="sxs-lookup"><span data-stu-id="d0440-152">Select the new queue in the left-hand menu to see the data explorer for this queue.</span></span> <span data-ttu-id="d0440-153">Som förväntat är kön tom.</span><span class="sxs-lookup"><span data-stu-id="d0440-153">As expected, the queue is empty.</span></span> <span data-ttu-id="d0440-154">Vi lägger till ett meddelande till kön med kommandot **Lägg till meddelande** överst i fönstret.</span><span class="sxs-lookup"><span data-stu-id="d0440-154">Let's add a message to the queue using the **Add Message** command at the top of the window.</span></span>

1. <span data-ttu-id="d0440-155">I dialogrutan **Lägg till meddelande** anger du ”Det här meddelandet kom från vår indatakö, new-feedback-q” i fältet **Meddelandetext** och klickar på **OK** längst ned i dialogrutan.</span><span class="sxs-lookup"><span data-stu-id="d0440-155">In the **Add Message** dialog, enter "This message came from our input queue, new-feedback-q" into the **Message text** field, and click **OK** at the bottom of the dialog.</span></span>

1. <span data-ttu-id="d0440-156">Observera meddelandet, som liknar meddelandet på följande skärmbild, i datautforskaren.</span><span class="sxs-lookup"><span data-stu-id="d0440-156">Observe the message, similar to the message in the following screenshot, in the data explorer.</span></span>
    <span data-ttu-id="d0440-157">![Skärmbild av lagringsutforskaren som visar vårt lagringskonto med det meddelande som vi skapade i kön.](../media/message-in-input-queue.png)</span><span class="sxs-lookup"><span data-stu-id="d0440-157">![Screenshot of Storage Explorer showing our storage account, with the message we created in the queue.](../media/message-in-input-queue.png)</span></span>

1. <span data-ttu-id="d0440-158">Efter några sekunder klickar du på **Uppdatera** för att uppdatera vyn av kön.</span><span class="sxs-lookup"><span data-stu-id="d0440-158">After a few seconds, click **Refresh** to refresh the view of the queue.</span></span> <span data-ttu-id="d0440-159">Observera att kön är **tom** igen.</span><span class="sxs-lookup"><span data-stu-id="d0440-159">Observe that the queue is **empty** once again.</span></span> <span data-ttu-id="d0440-160">Något måste ha läst meddelandet från kön.</span><span class="sxs-lookup"><span data-stu-id="d0440-160">Something must have read the message from the queue.</span></span>

1. <span data-ttu-id="d0440-161">Gå tillbaka till vår funktion i portalen och öppna fliken **Övervaka**. Välj det senaste meddelandet i listan.</span><span class="sxs-lookup"><span data-stu-id="d0440-161">Navigate back to our function in the portal, and open the **Monitor** tab. Select the newest message in the list.</span></span> <span data-ttu-id="d0440-162">Observera att vår funktion bearbetade det kömeddelande som vi hade publicerat till new-feedback-q.</span><span class="sxs-lookup"><span data-stu-id="d0440-162">Observe that our function processed the queue message we had posted to the new-feedback-q.</span></span> <span data-ttu-id="d0440-163">Resultaten kan vara fördröjda i den här loggen, så du kan behöva vänta några minuter och trycka på *Uppdatera*.</span><span class="sxs-lookup"><span data-stu-id="d0440-163">Results may be delayed by in this log, so you might have to wait a few minutes and hit *Refresh*.</span></span>

    ![Skärmbild av instrumentpanelen för övervakning som visar en post som talar om för oss att vår funktion bearbetade det kömeddelande som vi publicerade till new-feedback-q.](../media/message-in-monitor.png)

    <span data-ttu-id="d0440-165">I det här testet gjorde vi en fullständig tur och retur-resa genom att publicera något till kön och sedan se hur funktionen bearbetade det.</span><span class="sxs-lookup"><span data-stu-id="d0440-165">In this test, we did a complete round trip of posting something into our queue and then seeing the function process it.</span></span>

<span data-ttu-id="d0440-166">Vi gör framsteg med lösningen!</span><span class="sxs-lookup"><span data-stu-id="d0440-166">We're making progress with our solution!</span></span> <span data-ttu-id="d0440-167">Vår funktion utför nu något användbart.</span><span class="sxs-lookup"><span data-stu-id="d0440-167">Our function is now doing something useful.</span></span> <span data-ttu-id="d0440-168">Den tar emot text från våra indatakö och anropar sedan API för textanalys-tjänsten för att få en sentimentpoäng.</span><span class="sxs-lookup"><span data-stu-id="d0440-168">It's receiving text from our input queue and then calling out to the Text Analytics API service to get a sentiment score.</span></span> <span data-ttu-id="d0440-169">Vi har också lärt oss att testa funktionen via Azure-portalen och Storage Explorer.</span><span class="sxs-lookup"><span data-stu-id="d0440-169">We've also learned how to test our function through the Azure portal and the Storage Explorer.</span></span> <span data-ttu-id="d0440-170">I nästa övning ser vi hur enkelt det är att skriva till köer med hjälp av utdatabindningar.</span><span class="sxs-lookup"><span data-stu-id="d0440-170">In the next exercise, we'll see how easy it is to write to queues using output bindings.</span></span>